name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¸ç™¼æ¢ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ¨™ç±¤ (ä¾‹å¦‚ v1.0.0)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Get version from tag
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Update plugin.xml version
      run: |
        VERSION=${{ steps.version.outputs.VERSION }}
        sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/" src/main/resources/META-INF/plugin.xml
        echo "Updated plugin.xml version to: $VERSION"

    - name: Verify plugin
      run: ./gradlew verifyPlugin -Pversion=${{ steps.version.outputs.VERSION }}

    - name: Build plugin
      run: |
        ./gradlew buildPlugin -Pversion=${{ steps.version.outputs.VERSION }}
        echo "Generated files:"
        ls -la ./build/distributions/

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## CodeIgniter Load Analyzer Plugin ${{ steps.version.outputs.VERSION }}

          ### åŠŸèƒ½ç‰¹è‰²
          - ğŸš€ ä¸€éµç”Ÿæˆ PHPDoc å±¬æ€§è¨»è§£
          - ğŸ” æ™ºèƒ½åˆ†æ `$this->load` èª¿ç”¨
          - ğŸ¯ ç²¾ç¢ºæ˜ å°„é¡åˆ¥åç¨±
          - ğŸ”„ è‡ªå‹•å»é‡è¤‡å±¬æ€§
          - âœ¨ å®Œç¾æ•´åˆåˆ° IDE å·¥ä½œæµç¨‹

          ### æ”¯æ´çš„ IDE
          - IntelliJ IDEA Community/Ultimate 2023.1+
          - PhpStorm 2023.1+
          - WebStorm 2023.1+

          ### å®‰è£æ–¹æ³•
          1. ä¸‹è¼‰ä¸‹æ–¹çš„ `ci-load-analyzer-plugin-${{ steps.version.outputs.VERSION }}.zip`
          2. åœ¨ IDE ä¸­ï¼š`File` â†’ `Settings` â†’ `Plugins` â†’ `âš™ï¸` â†’ `Install Plugin from Disk...`
          3. é¸æ“‡ä¸‹è¼‰çš„ ZIP æª”æ¡ˆ
          4. é‡æ–°å•Ÿå‹• IDE

          ### ä½¿ç”¨æ–¹æ³•
          1. é–‹å•ŸåŒ…å« CodeIgniter `$this->load` èª¿ç”¨çš„ PHP æª”æ¡ˆ
          2. å³éµé»æ“Š â†’ `Generate CodeIgniter Properties`
          3. è‡ªå‹•ç”Ÿæˆå°æ‡‰çš„ `@property` è¨»è§£
        draft: false
        prerelease: false
        files: |
          ./build/distributions/*.zip

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: plugin-build-${{ steps.version.outputs.VERSION }}
        path: |
          build/distributions/*.zip
          build/reports/
        retention-days: 30